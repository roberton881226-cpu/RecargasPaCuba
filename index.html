<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RecargasPaCuba</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <meta name="theme-color" content="#0d63c9">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, Arial, sans-serif;
      background:#0b0f13;
      color:white;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    .app{max-width:820px;margin:auto;width:100%;padding:16px;flex:1 0 auto}

    /* HEADER con bandera de Cuba en degradado */
    header.appbar{
      background: linear-gradient(
        to bottom right,
        rgba(0,91,187,0.85),
        rgba(255,255,255,0.18),
        rgba(206,17,38,0.85)
      );
      color:white;
      padding:18px 22px;
      text-align:center;
      border-bottom-left-radius:12px;
      border-bottom-right-radius:12px;
    }
    header.appbar h1{margin:0;font-size:20px;font-weight:800;letter-spacing:0.4px;}
    header.appbar .greeting{margin-top:6px;font-size:13px;color:rgba(255,255,255,0.92);font-weight:600;}

    .tabs{display:flex;gap:8px;justify-content:center;margin-bottom:10px;margin-top:14px}
    .tab-btn{
      padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.05);color:white;cursor:pointer;min-width:110px;text-align:center;font-weight:600;
    }
    .tab-btn.active{background:linear-gradient(90deg,#2ea3ff,#0080ff);}

    /* Promo banner */
    .promo-banner{
      background: linear-gradient(90deg,#ffefc2,#ffd27a);
      color:#2b2b2b;padding:10px 12px;border-radius:10px;margin:12px 0;font-weight:700;display:flex;align-items:center;gap:10px;
    }

    .offers{margin:auto;max-width:820px}
    .offer-card{
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,0.04);border-radius:12px;padding:12px;margin-bottom:12px;
      box-shadow: 0 6px 16px rgba(2,8,18,0.45);
    }

    /* Logos temporales */
    .logo-cubacel{background:#005bbb;padding:10px;border-radius:8px;color:white;font-weight:800;width:60px;text-align:center;display:flex;align-items:center;justify-content:center;}
    .logo-nauta{background:#bb001b;padding:10px;border-radius:8px;color:white;font-weight:800;width:60px;text-align:center;display:flex;align-items:center;justify-content:center;}

    .offer-info{margin-left:12px}
    .offer-title{font-weight:700;color:white}
    .offer-sub{font-size:13px;color:#c8d4e0;margin-top:4px}
    .price{font-size:16px;font-weight:700;color:white}

    .btn-buy{background:#0d63c9;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}

    /* BARRA inferior actualizada */
    nav.bottom{
      position:sticky;bottom:0;display:flex;justify-content:space-around;padding:10px;
      background:rgba(255,255,255,0.08); /* color nuevo */
      border-top-left-radius:16px;border-top-right-radius:16px;backdrop-filter:blur(8px);
    }
    .nav-btn{color:white;cursor:pointer;text-align:center;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
    .nav-btn.active{font-weight:800}

    /* HOME + Login + Registro tarjeta */
    .home-screen {padding:20px;text-align:center}
    .card {
      margin:18px auto 0;
      background:rgba(255,255,255,0.06);
      padding:16px;border-radius:12px;max-width:520px;
    }
    .card h3{margin-bottom:10px}
    .row{display:flex;gap:8px;align-items:center;justify-content:center}
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"]{
      padding:10px 12px;border-radius:8px;border:none;background:rgba(0,0,0,0.35);color:white;width:100%;
    }
    .btn-primary{
      background:#0d63c9;color:white;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;
    }
    .btn-tertiary{
      background:transparent;color:#cbd5e1;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;cursor:pointer;
    }
    .small-ghost{background:transparent;border:none;color:#cbd5e1;cursor:pointer;margin-top:10px}

    /* CUENTA */
    .saldo-box{background:rgba(255,255,255,0.06);padding:18px;border-radius:12px;margin-bottom:20px;text-align:center}
    .saldo-monto{font-size:26px;font-weight:800;margin-top:8px}
    .btn-saldo{background:#3db0ff;color:white;padding:10px 14px;margin-top:14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;width:100%;max-width:280px}

    .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:999}
    .modal{background:#121a24;padding:20px;border-radius:12px;width:90%;max-width:350px;text-align:center}
    .pago-btn{background:#0e7be2;color:white;padding:12px;border:none;border-radius:10px;width:100%;margin-top:10px;font-weight:700;cursor:pointer}
    .pago-btn.cancel{ background:#555;margin-top:14px }

    @media (max-width:420px){
      .offer-card{padding:10px}
      .logo-cubacel,.logo-nauta{width:50px;padding:8px}
    }
  </style>
</head>

<body>
<header class="appbar">
  <h1>RecargasPaCuba</h1>
  <div class="greeting" id="header-greeting" aria-live="polite"></div>
</header>

<main class="app" id="app">

  <!-- HOME -->
  <section id="screen-home" class="home-screen" style="display:none;">
    <h2 id="home-title">Bienvenido</h2>
    <p id="home-sub" style="color:#c9d3df;margin-top:8px;">Accede con tu cuenta para continuar.</p>

    <!-- TARJETA: login o registro (se reemplaza entre s√≠) -->
    <div class="card" id="auth-card">
      <!-- LOGIN (por defecto visible) -->
      <div id="login-form">
        <h3>Iniciar sesi√≥n</h3>
        <div style="margin-bottom:8px;color:#c9d3df">Puedes usar tu correo o nombre de usuario</div>
        <div style="margin-bottom:8px">
          <input id="login-identifier" placeholder="Correo o usuario" aria-label="Correo o usuario">
        </div>
        <div style="margin-bottom:8px">
          <input id="login-password" type="password" placeholder="Contrase√±a" aria-label="Contrase√±a">
        </div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn-primary" id="btn-login-do">Entrar</button>
        </div>
      </div>

      <!-- BUTTON registrarse justo debajo del cuadro -->
      <div style="text-align:center;margin-top:12px">
        <button class="btn-tertiary" id="btn-show-register">Registrarse</button>
      </div>

      <!-- REGISTRO (oculto inicialmente) -->
      <div id="register-form" style="display:none;margin-top:14px">
        <h3>Crear cuenta</h3>
        <div style="margin-bottom:8px;color:#c9d3df">Contrase√±a obligatoria. Puedes poner usuario o correo (o ambos).</div>

        <div style="margin-bottom:8px">
          <input id="reg-username" placeholder="Nombre de usuario (opcional)" aria-label="Nombre de usuario">
        </div>
        <div style="margin-bottom:8px">
          <input id="reg-email" type="email" placeholder="Correo electr√≥nico (opcional)" aria-label="Correo electr√≥nico">
        </div>
        <div style="margin-bottom:8px">
          <input id="reg-phone" type="tel" placeholder="Tel√©fono (opcional)" aria-label="Tel√©fono">
        </div>
        <div style="margin-bottom:8px">
          <input id="reg-password" type="password" placeholder="Contrase√±a (obligatoria)" aria-label="Contrase√±a">
        </div>

        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn-primary" id="btn-register-do">Crear cuenta</button>
          <button class="btn-tertiary" id="btn-cancel-register">Volver</button>
        </div>
      </div>
    </div>
  </section>

  <!-- RECARGAR -->
  <section id="screen-recargar" style="display:none;">
    <div id="promo-container" style="display:none;">
      <div class="promo-banner" id="promo-banner"></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-cubacel" aria-selected="true">CUBACEL</button>
      <button class="tab-btn" id="tab-nauta" aria-selected="false">NAUTA</button>
    </div>

    <div class="offers" id="offers-list" aria-live="polite"></div>
  </section>

  <!-- HISTORIAL -->
  <section id="screen-historial" class="placeholder" style="display:none">
    <div>Historial vac√≠o por ahora.</div>
  </section>

  <!-- CUENTA -->
  <section id="screen-cuenta" style="display:none">
    <div class="saldo-box">
      <div>Saldo disponible</div>
      <div class="saldo-monto" id="saldo-monto">0.00 EUR</div>
      <button class="btn-saldo" id="btn-agregar-saldo">Agregar saldo</button>
    </div>

    <!-- Perfil (se muestra si hay usuario) -->
    <div class="card" id="profile-card" style="display:none">
      <h3>Perfil</h3>
      <div id="profile-username" style="font-weight:700;margin-bottom:6px"></div>
      <div id="profile-email" style="color:#c9d3df;margin-bottom:6px"></div>
      <div id="profile-phone" style="color:#c9d3df;margin-bottom:12px"></div>

      <div style="display:flex;gap:8px;flex-direction:column;align-items:center">
        <div style="width:100%;max-width:360px;text-align:left;color:#c9d3df;margin-bottom:8px">M√©todos de pago guardados (demo)</div>
        <div style="width:100%;max-width:360px;display:flex;gap:8px">
          <button class="btn-tertiary" id="pay-bizum">Bizum</button>
          <button class="btn-tertiary" id="pay-card">Tarjeta</button>
          <button class="btn-tertiary" id="pay-paypal">PayPal</button>
        </div>
        <button class="btn-logout" id="btn-profile-logout" style="display:block;margin-top:12px">Cerrar sesi√≥n</button>
      </div>
    </div>

  </section>

</main>

<nav class="bottom" role="navigation" aria-label="Navegaci√≥n">
  <div class="nav-btn" id="nav-home">Inicio</div>
  <div class="nav-btn active" id="nav-recargar">Recargar</div>
  <div class="nav-btn" id="nav-historial">Historial</div>
  <div class="nav-btn" id="nav-cuenta">Cuenta</div>
</nav>

<!-- MODAL -->
<div class="modal-bg" id="modal-bg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Agregar saldo">
    <div style="margin-bottom:10px;font-weight:700">Agregar saldo</div>
    <button class="pago-btn" data-metodo="Bizum">Bizum</button>
    <button class="pago-btn" data-metodo="Tarjeta">Tarjeta (Visa/Mastercard)</button>
    <button class="pago-btn" data-metodo="PayPal">PayPal</button>
    <button class="pago-btn cancel" id="cerrar-modal">Cancelar</button>
  </div>
</div>

<script>
/* Service Worker (sin cambios) */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');

/* PROMO (modo demo) */
const PROMO = { active: true, text: "üéÅ Promo Cubacel: +1GB adicional en recargas hoy" };

/* STORAGE key */
const STORAGE_KEY = 'rpc_user'; // guardamos objeto JSON: { username, email, phone, passwordHash?, created }

/* Helpers */
function saveUserToStorage(userObj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(userObj));
}
function getUserFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : null;
}
function clearUserFromStorage(){
  localStorage.removeItem(STORAGE_KEY);
}

/* UI refs */
const headerGreeting = document.getElementById('header-greeting');
const homeTitle = document.getElementById('home-title');
const homeSub = document.getElementById('home-sub');

const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const authCard = document.getElementById('auth-card');
const btnShowRegister = document.getElementById('btn-show-register');
const btnCancelRegister = document.getElementById('btn-cancel-register');

/* Login inputs */
const loginIdentifier = document.getElementById('login-identifier');
const loginPassword = document.getElementById('login-password');
const btnLoginDo = document.getElementById('btn-login-do');

/* Register inputs */
const regUsername = document.getElementById('reg-username');
const regEmail = document.getElementById('reg-email');
const regPhone = document.getElementById('reg-phone');
const regPassword = document.getElementById('reg-password');
const btnRegisterDo = document.getElementById('btn-register-do');

/* Profile UI */
const profileCard = document.getElementById('profile-card');
const profileUsername = document.getElementById('profile-username');
const profileEmail = document.getElementById('profile-email');
const profilePhone = document.getElementById('profile-phone');
const btnProfileLogout = document.getElementById('btn-profile-logout');

/* Offers & balance */
let saldo = 0;
const saldoMonto = document.getElementById("saldo-monto");
const btnAgregarSaldo = document.getElementById("btn-agregar-saldo");
const modalBG = document.getElementById("modal-bg");

/* Payment buttons inside profile demo */
const payBizum = document.getElementById('pay-bizum');
const payCard = document.getElementById('pay-card');
const payPayPal = document.getElementById('pay-paypal');

/* Init UI state */
function updateUIForUser(user){
  if(user){
    const name = user.username || (user.email ? autoUsernameFromEmail(user.email) : '');
    headerGreeting.textContent = `Hola, ${name} üëã`;
    homeTitle.textContent = `Hola, ${name} üëã`;
    homeSub.textContent = 'Listo para enviar recargas?';

    // hide auth card actions
    loginForm.style.display = 'none';
    registerForm.style.display = 'none';
    btnShowRegister.style.display = 'none';

    // profile
    profileCard.style.display = 'block';
    profileUsername.textContent = user.username ? `@${user.username}` : `(sin usuario)`;
    profileEmail.textContent = user.email ? `‚úâ ${user.email}` : '';
    profilePhone.textContent = user.phone ? `üìû ${user.phone}` : '';

    btnProfileLogout.style.display = 'block';
  } else {
    headerGreeting.textContent = '';
    homeTitle.textContent = 'Bienvenido';
    homeSub.textContent = 'Accede con tu cuenta para continuar.';

    loginForm.style.display = '';
    registerForm.style.display = 'none';
    btnShowRegister.style.display = '';
    profileCard.style.display = 'none';
    btnProfileLogout.style.display = 'none';
  }
}

/* Auto-username from email */
function autoUsernameFromEmail(email){
  if(!email) return '';
  const local = email.split('@')[0] || '';
  return local.replace(/[^a-zA-Z0-9_\-]/g,'').toLowerCase();
}

/* Simple password policy (demo) */
function validPassword(p){
  return p && p.length >= 6;
}

/* Registro: crea usuario en localStorage */
btnRegisterDo.addEventListener('click', ()=>{
  const username = regUsername.value && regUsername.value.trim();
  const email = regEmail.value && regEmail.value.trim();
  const phone = regPhone.value && regPhone.value.trim();
  const password = regPassword.value && regPassword.value;

  if(!validPassword(password)){
    alert('La contrase√±a es obligatoria y debe tener al menos 6 caracteres.');
    return;
  }

  // Si no puso username pero puso email, generar username
  let finalUsername = username;
  if(!finalUsername && email) finalUsername = autoUsernameFromEmail(email);

  const userObj = {
    username: finalUsername || null,
    email: email || null,
    phone: phone || null,
    password: password, // demo: guardamos contrase√±a tal cual (no para producci√≥n)
    created: Date.now()
  };

  saveUserToStorage(userObj);
  updateUIForUser(userObj);
  alert('Cuenta creada. Has iniciado sesi√≥n (modo demo).');
  show('home');
});

/* Mostrar formulario de registro */
btnShowRegister.addEventListener('click', ()=>{
  loginForm.style.display = 'none';
  registerForm.style.display = '';
});

/* Cancelar registro -> volver a login */
btnCancelRegister.addEventListener('click', ()=>{
  registerForm.style.display = 'none';
  loginForm.style.display = '';
});

/* Login: aceptar usuario o correo + contrase√±a */
btnLoginDo.addEventListener('click', ()=>{
  const id = loginIdentifier.value && loginIdentifier.value.trim();
  const pwd = loginPassword.value && loginPassword.value;

  if(!id || !pwd){
    alert('Introduce usuario/correo y contrase√±a.');
    return;
  }

  const user = getUserFromStorage();
  if(!user || !user.password){
    alert('No hay cuentas registradas (modo demo). Reg√≠strate primero.');
    return;
  }

  // Identificar por correo o username
  const matchesIdentifier = (user.username && id === user.username) || (user.email && id.toLowerCase() === user.email.toLowerCase());
  if(matchesIdentifier && pwd === user.password){
    updateUIForUser(user);
    alert('Sesi√≥n iniciada (modo demo).');
    show('home');
  } else {
    alert('Usuario/Correo o contrase√±a incorrectos (modo demo).');
  }
});

/* Logout profile */
btnProfileLogout.addEventListener('click', ()=>{
  if(confirm('Cerrar sesi√≥n? (modo demo)')){
    clearUserFromStorage();
    updateUIForUser(null);
    show('home');
  }
});

/* -------------------------
   SALDO (modo demo)
------------------------- */
btnAgregarSaldo?.addEventListener("click", ()=> {
  modalBG.style.display = "flex";
  modalBG.setAttribute('aria-hidden','false');
});
document.getElementById("cerrar-modal")?.addEventListener("click", ()=> {
  modalBG.style.display = "none";
  modalBG.setAttribute('aria-hidden','true');
});
document.querySelectorAll(".pago-btn[data-metodo]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    saldo += 10;
    saldoMonto.textContent = saldo.toFixed(2) + " EUR";
    modalBG.style.display="none";
    modalBG.setAttribute('aria-hidden','true');
    alert("Saldo agregado (demo)");
  });
});

/* -------------------------
   OFERTAS (con bloqueo de compra si no logueado)
------------------------- */
const CUBACEL = [
  { title: "EUR 10,42 ‚Äî Recarga m√≠nima", details:"Recarga m√≠nima v√°lida" },
  { title: "EUR 20,84 ‚Äî Recarga 500 CUP + bonus", details:"Promo con bonus y datos" },
  { title: "EUR 25,01 ‚Äî Recarga 600 CUP + pack", details:"Pack combinado" },
  { title: "EUR 29,18 ‚Äî Recarga 700 CUP + datos", details:"Pack + datos" },
  { title: "EUR 31,26 ‚Äî 10GB (solo 4G)", details:"Datos + minutes" },
  { title: "EUR 41,68 ‚Äî 16GB solo 4G", details:"Datos para 30 d√≠as" },
  { title: "EUR 21,98 ‚Äî Paquete especial", details:"Paquete y minutos" },
  { title: "EUR 65,93 ‚Äî Modem data 50GB", details:"Datos para dispositivos" }
];

const NAUTA = [
  { title: "EUR 8,12 ‚Äî Nauta Plus (15 d√≠as)", details:"Acceso Nauta Plus 15D" },
  { title: "EUR 13,53 ‚Äî Nauta Plus (30 d√≠as)", details:"Acceso Nauta Plus 30D" },
  { title: "EUR 10,46 ‚Äî NAUTA m√≠nima", details:"Recarga NAUTA m√≠nima" },
  { title: "EUR 52,20 ‚Äî NAUTA Max", details:"Recarga NAUTA m√°xima" }
];

const offersList = document.getElementById("offers-list");

function userIsLoggedIn(){
  return !!getUserFromStorage();
}

function renderOffers(type){
  offersList.innerHTML = "";
  const list = type === "CUBACEL" ? CUBACEL : NAUTA;

  list.forEach((o, i)=>{
    offersList.innerHTML += `
      <div class="offer-card" role="article">
        <div style="display:flex;align-items:center;gap:12px">
          ${type === "CUBACEL"
            ? `<div class="logo-cubacel">CU</div>`
            : `<div class="logo-nauta">NA</div>`}
          <div class="offer-info">
            <div class="offer-title">${o.title}</div>
            <div class="offer-sub">${o.details}</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="price">${(o.title.match(/EUR\\s?[0-9.,]+/i)||[o.title])[0]}</div>
          <button class="btn-buy" data-offer="${i}" data-type="${type}">${ userIsLoggedIn() ? 'Comprar' : 'Entrar para comprar' }</button>
        </div>
      </div>
    `;
  });

  // listeners compra
  offersList.querySelectorAll('.btn-buy').forEach(btn=>{
    btn.addEventListener('click', e=>{
      if(!userIsLoggedIn()){
        alert('Debes iniciar sesi√≥n para comprar.');
        show('home');
        return;
      }
      const idx = parseInt(e.currentTarget.dataset.offer,10);
      const t = e.currentTarget.dataset.type;
      const selected = (t === 'CUBACEL' ? CUBACEL[idx] : NAUTA[idx]);
      alert('Comprar (modo demo): ' + selected.title);
    });
  });
}

/* Tabs */
document.getElementById("tab-cubacel").addEventListener("click", ()=>{
  document.getElementById("tab-cubacel").classList.add("active");
  document.getElementById("tab-nauta").classList.remove("active");
  renderOffers("CUBACEL");
});
document.getElementById("tab-nauta").addEventListener("click", ()=>{
  document.getElementById("tab-nauta").classList.add("active");
  document.getElementById("tab-cubacel").classList.remove("active");
  renderOffers("NAUTA");
});

/* NAV y pantallas */
function updatePromoUI(){
  const promoContainer = document.getElementById('promo-container');
  const promoBanner = document.getElementById('promo-banner');
  if(PROMO && PROMO.active){
    promoBanner.textContent = PROMO.text;
    promoContainer.style.display = '';
  } else promoContainer.style.display = 'none';
}

function show(screen){
  document.querySelectorAll("main section").forEach(s=>s.style.display="none");
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));

  const el = document.getElementById("screen-"+screen);
  if(el) el.style.display="block";
  const nav = document.getElementById("nav-"+screen);
  if(nav) nav.classList.add("active");

  if(screen === 'recargar'){
    updatePromoUI();
    const activeTab = document.querySelector('.tab-btn.active');
    const type = activeTab && activeTab.id === 'tab-nauta' ? 'NAUTA' : 'CUBACEL';
    renderOffers(type);
  }

  if(screen === 'cuenta'){
    const u = getUserFromStorage();
    if(u) {
      profileCard.style.display = 'block';
      profileUsername.textContent = u.username ? `@${u.username}` : `(sin usuario)`;
      profileEmail.textContent = u.email ? `‚úâ ${u.email}` : '';
      profilePhone.textContent = u.phone ? `üìû ${u.phone}` : '';
    } else {
      profileCard.style.display = 'none';
    }
  }
}

/* NAV buttons */
document.getElementById("nav-home").onclick = ()=> show("home");
document.getElementById("nav-recargar").onclick = ()=> show("recargar");
document.getElementById("nav-historial").onclick = ()=> show("historial");
document.getElementById("nav-cuenta").onclick = ()=> show("cuenta");

/* Inicializaci√≥n */
const existing = getUserFromStorage();
if(existing) updateUIForUser(existing);
renderOffers('CUBACEL');
show('home'); /* ahora abre en Inicio */

/* profile logout */
btnProfileLogout.addEventListener('click', ()=>{
  if(confirm('Cerrar sesi√≥n? (modo demo)')){
    clearUserFromStorage();
    updateUIForUser(null);
    show('home');
  }
});

/* small demo payment toggles (no guardan realmente) */
payBizum.addEventListener('click', ()=> alert('Bizum guardado (demo)'));
payCard.addEventListener('click', ()=> alert('Tarjeta guardada (demo)'));
payPayPal.addEventListener('click', ()=> alert('PayPal guardado (demo)'));
</script>

</body>
</html>
